---
title: "Global Life Expectancy: Unraveling Health and Economic Determinants (2015-2020)"
subtitle: "Multiple Linear Regression Analyzing Critical Factors Shaping Life Expectancy "
author: 
  - Yanfei Huang
thanks: "Code and data are available at: [https://github.com/wendyhuan/lifeexpectancy](https://github.com/wendyhuan/lifeexpectancy)."
date: 02 December 2024
date-format: long
abstract: "This paper analyze life expectancy and its determinants through 184 countries and make the prediction of people from different Income Group. Multiple Linear regression is used to deploying the life expectanc with gender, income and region. Predictions of life expectancy of people from different income group is made according to these essential predictors. The finding indicates that the life expectancy is tend to get higher as the economic class grows. And we predict that the average age of person from low, lower-middle, upper-middle and high are 65,70, 75,80. The result of this paper will help in suggesting a country which area should be given importance in order to efficiently improve the life expectancy of its population."
format: pdf
toc: true
toc-depth: 3
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

# Install Packages if not downloaded:
required_packages <- c(
  "tidyverse", "sf", "dplyr", "here", "arrow", "ggplot2", "janitor", "purrr", "knitr", "kableExtra", "ggcorrplot", "modelsummary", "countrycode", "gridExtra"
)
for (p in required_packages) {
  if (!require(p, character.only = TRUE)) {
    install.packages(p, character.only = TRUE)
  }
}

#load libraries
library(tidyverse)
library(sf)
library(dplyr)
library(here)
library(arrow)
library(ggplot2)
library(janitor)
library(purrr)
library(knitr)
library(kableExtra)
library(ggcorrplot)
library(modelsummary)
library(countrycode)
library(gridExtra)

# load data
lelecleaned_data <- read_parquet("~/lifeexpectancy/data/02-analysis_data/lelecleaned.parquet")
lea60 <- read_parquet("~/lifeexpectancy/data/02-analysis_data/lea60.parquet")
leab <- read_parquet("~/lifeexpectancy/data/02-analysis_data/leab.parquet")
male_table <- read_parquet("~/lifeexpectancy/data/02-analysis_data/male_table.parquet")
female_table <- read_parquet("~/lifeexpectancy/data/02-analysis_data/female_table.parquet")
```

# Introduction

Life expectancy is a critical measure of a population's overall health and well-being, shaped by various factors such as gender, geographic location and economic group. The index of life expectancy is generally served as a benchmark for income group, indicating the effectiveness of interventions in reducing mortality and improving well-being. Higher life expectancy is believed to linked to stronger physical factor, better living standards, and geographic location. Conversely, low life expectancy often signals systemic challenges such as weaker health, lower economic situation, and inadequate healthcare access of different region. [@socialdeterminantsofhealth].

The primary goal of this paper is to determine which factors play a statistically significant role in driving lower life expectancy values and to offer actionable insights based on different income group. According to the World Bank Income Group, the countries are classified into low, lower-middle, upper-middle, and high based on the country's Gross National Income. Using Multiple Linear Regression model and Bayesian model, this study focuses on understanding the relationship between Gender, Region and different income group in predicting life expectancy across different countries. By identifying and analyzing these predictors, the study aims to highlight actionable aspects for policymakers to target in their efforts to improve population longevity effectively.

Related Research has shown that there exist difference between men and women related with biological, behavioral, and socioeconomic factors, highlighting that gender-specific health behaviors and societal roles influence longevity [@GenderandLifeExpectancy]. Higher-income individuals tend to live longer due to better access to healthcare and healthier lifestyles, with notable regional disparities even within similar income groups [@IncomeGroupsandLongevity]. Additionally, regional socioeconomic differences on health outcomes, especially life expectancy. It emphasizes that addressing regional inequities in wealth and resources is essential for improving population health globally. [@RegionalVariations].

Findings from this paper reveal that countries of higher income group tend to achieve higher life expectancy, while factors like lower income and poverty region emerge as significant obstacles. The analysis underscores the importance of targeted interventions in key areas such as healthcare accessibility and economic equity to address disparities in life expectancy. This study further contributes to a deeper understanding of how predictive modeling under different country status can inform public health strategies and policy-making on a global scale.

The ultimate goal is to assist policymakers in developing evidence-based strategies that can enhance population health outcomes. The approach of this paper not only emphasizes the importance of equitable access to healthcare but also contributes to a broader understanding of the multifaceted factors shaping life expectancy globally. By highlighting the interplay between various determinants, this study contributes to a broader understanding of the challenges and opportunities in improving life expectancy on a global scale.

The structure of the paper is as follows: [@sec-data] outlines the data sources and variables considered, followed by the model setup in [@sec-modset] and justification in [@sec-modjust]. The results in [@sec-result] presents the key findings of the analysis, with a discussion on the implications. [@sec-discussion] then discusses potential limitations and suggestions for future research. [@sec-appx] provides additional detailed information about the data, model and methodology.

# Data {#sec-data}

## Overview

The data used in this analysis originates from The World Health Organization’s (WHO) and Global Health Observatory (GHO) [@lifeexpectancy]. This data-set related to life expectancy, health factors for 184 countries has been collected from WHO data repository website and its corresponding economic data was collected from United Nation website. Among all categories of health-related factors only those socio-economic factors on the national level were chosen for global scale analysis.

This analysis uses the statistical programming language R [@citeR] and several libraries, including `tidyverse` [@tidyverse], `janitor` [@janitor], `knitr` [@knitr], `dplyr` [@dplyr], `arrow` [@arrow], `purrr` [@purrr], `sf` [@sf], and `here` [@here] for data manipulation. `ggplot2` [@ggplot], `ggcorrplot` [@ggcorrplot] and `kableExtra` [@kableExtra] for visualization. The dataset covers various predictors conducted across multiple countries, capturing the support for a country to determine the predicting factor which is contributing to lower value of life expectancy.

## Measurement

The measurement process refers to how real-world factors—such as the Gender, geographic location of a country and income group - are translated into numerical entries representing life expectancy in a dataset. Each entry captures the average life expectancy of individuals in a specific country during a given year.

**Life Expectancy (`Life Expectancy`)**: This variable, life expectancy at birth, represents the number of years a person is expected to live , assuming current mortality conditions persist. It is derived using data from national health records, the World Health Organization (WHO) and Global Health Observatory (GHO). The data on the raw dataset is recorded as a range of age. For simple analysis, we drop the range and take the average of year with one decimal. The values are calculated and represented in age between 10.1 to 87.4.

**Income Group(`Income_Group`)**: This is a categorical variable that classifies countries into four groups by the country's Gross National Income according to the latest index from World Bank Income Group. The countries are classified into low, lower-middle, upper-middle, and high under the standard as follow. Low-income economies is defined as a country with a gross national income less than \$1135, lower-middle is between the range to \$1136 to \$4465, upper-middle in the range of \$4465 to \$13845 and high is more than \$13846.

**Gender(`Gender`)**: The gender of the population of each country is included as a categorical variable (Male/Female/Both Sex).

**Region(Region)**: This is a categorical variable that classifies the geographic location of the countries. It is mapped one by one by the name of the country. The data is stored as the name of the continent(‘Africa’, ‘Oceania’, ‘Asia’, ‘Europe’, ‘North America’, ‘South America’).

## Data Cleaning

The raw life expectancy data underwent a several cleaning steps to ensure it was accurate, consistent and ready for analysis. The goal of this cleaning process is to create a table including income group (high, upper middle, lower middle, low), gender (Male, Female, Both Sex), region (Asia, Europe, North America, South America, Africa, Oceania) as rows and life expectancy as column.

To make such table, we first select and rename key variables from raw data to focus on relevant information. To make the subsequent analysis easier, we then convert variables to the proper data types and eliminate the rows that have missing data values. To keep things neat, we organize the decimal for every piece of numerical data and drop the percentage symbol. The income group column and the region column was not given in the raw dataset. We created a mapping over country name to four income group according to the index given by World Bank Income Group and save the data under "Income_Group". We as well made a mapping to the countries according to its continent and saved as "Region". We again merge the table, removing repeated columns and rows. For easier visualization, we created four tables, which are grouped by life expectancy at age 60, life expectancy at birth, life expectancy at birth of Male and life expectancy at birth of Female. 

The cleaned dataset was then saved as both CSV and Parquet file for efficient storage and further analysis.

More information on the data cleaning process can be found in @sec-appx.

## Outcome Variables

The outcome variable is **`Life Expendency`**. This is the primary dependent variable that the model is designed to predict. It represents the average number of years a person is expected to live, under the condition that current mortality conditions persist. The model seeks to identify the variables affecting this average. To examine the differences in life expectancy under the same variables, we separate the data into developed and developing countries, where developed country are generally believed to have higher life expectancy. @fig-expectancy displays density of the historical data of life expectancy across 195 countries from 2000 to 2015, comparing developing to developed countries.The average age of most developed country is approximately 80, while the majority developing countries typically have average life expectancy around mid-seventies.

```{r}
#| label: fig-expectancy
#| fig-cap: "This histogram shows the distribution of the percentage of life expectancy dividing by the status of countries. The graph of developed countries shows narrower spread with density curve located on the rightside of the x-axis. The graph of developing countries performs a wider spread while the highest density position at mid-seventies."
#| echo: false
#| eval: true
#| warning: false
#| message: false


# create plot of historical 184 countries life expectancy dividing by country status. 
ggplot(lelecleaned, aes(x = `Life Expectancy`)) +
  geom_histogram(aes(y = ..density..), 
                 bins = 70, fill = "salmon", color = "pink", alpha = 0.9) +
  geom_density(color = "royalblue", fill = "lightblue", alpha = 0.6) +
  labs(
    title = "Distribution of Life Expectancy",
    x = "Life Expectancy", y = "Density"
  ) +
  theme_minimal() +
  facet_wrap(~Status)

```

## Predictor Variables

The **predictor variables** (or independent variables) are the factors believed to influence the life expectancy:

1.  **Income Group(`Income_Group`)**: The income group of a country is the key factor influencing the life expectancy. This variable provides context for comparing life expectancy between different levels of country income group. The division of the life expectancy by the income group of a country because income levels often correlate strongly with various factors affecting health and longevity. Higher income countries typically have more resources to invest in robust healthcare systems, with better living conditions while lower income countries often face challenges such as inadequate healthcare infrastructure and malnutrition. 

Following by the four income group, we would like to see the distribution of the income group of 184 WHO member countries. @fid-income shows that there are 55 countries at the high income group, 26 countries at low income group, 54 countries at the lower-middle group while there are 49 countries at the upper-middle group. With significant less low income countries, we expect to see the life expectancy lie in a comparably higher range. On the other hand, there might exist sever outliers dropping the mean. 

2.  **Gender(`Gender`)**: The gender of the population of each country is included as a categorical variable (Male/Female/Both Sex). This is a key variable in the dataset because gender has been fully recognized connected with the biological physical factor which directly effect the life expectancy. @fig-gender shows that the with an stable average of 74, life expectancy of female is constantly higher than male's average of 70. The line plot reveals a steady increase until 2019, followed by a sharp decline in 2020, which is assumed to be associated with the impact of COVID-19.

3.  **Region(Region)**: This is a categorical variable that classifies the geographic location of the countries. It is mapped one by one by the name of the country. The data is stored as the name of the continent(‘Africa’, ‘Oceania’, ‘Asia’, ‘Europe’, ‘North America’, ‘South America’). @fig-region indicates that with the number of 54, Africa has the most WHO member countries. Both Asia and Europe has 43 countries,listing in the middle while the other three continent has the significant less number of countries. North America has 22 countries, South America has 12 countries and Oceania has the least, 10 countries. 

```{r}
#| label: fig-income
#| fig-cap: "Distribution of country income group."
#| echo: false
#| eval: true
#| warning: false
#| message: false

# Count the number of unique countries for each Status
country_counts <- lelecleaned_data %>%
  # Ensure each country is only counted once
  distinct(Country, Income_Group) %>%  
   # Count the number of countries in each Status category
  count(Income_Group)  

# Create a bar plot to show the distribution of countries by Status
ggplot(country_counts, aes(x = Income_Group, y = n, fill = Income_Group)) +
   # Use 'identity' to directly use the count values
  geom_bar(stat = "identity") + 
   # Add count labels on top of bars
  geom_text(aes(label = n), vjust = -0.5,size = 2.5) +  
  labs(
    title = "Distribution of Country by Income Group",
    x = "Income Group",
    y = "Number of Countries"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("lower_income" = "skyblue", "lower_middle" = "darkblue", "upper_middle" = "blue", "high_income" = "lightblue")) +
  theme(
    legend.position = "none", 
  plot.title = element_text(size = 15,face = "bold"))

```

```{r}
#| label: fig-region
#| fig-cap: "Distribution of different region of the 184 countries. Africa has the most countries with an number of 54. Asia and Europe has the same amount of 43, North America has 22 countries while the other two continent has almost the same amount of countries."
#| echo: false
#| eval: true
#| warning: false
#| message: false

# Group by Region and count the number of countries
region_counts <- lelecleaned_data %>%
  distinct(Country, Region) %>%  # Ensure each country is only counted once
  count(Region)  # Count the number of distinct countries in each Region

# Plot: Distribution of countries in different regions
ggplot(region_counts, aes(x = Region, y = n, fill = Region)) +
  geom_bar(stat = "identity") +  # Plot the count of countries
  geom_text(aes(label = n), vjust = -0.3, size = 3) +  # Add count labels on top of bars
  labs(
    title = "Distribution of Countries by Region",
    x = "Region",
    y = "Number of Countries"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3") +  # Color palette for different regions
  theme(
    legend.position = "none",
    plot.title = element_text(size = 10, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate axis labels for clarity
  )

```

```{r}
#| label: fig-gender
#| fig-cap: "Distribution of gender each year. The average of female life expectancy is approximately 74 around years, constantly higher than male's average of 70. Compared to male, female's life expectancy is marginally more steady."
#| echo: false
#| eval: true
#| warning: false
#| message: false

# Calculate the average life expectancy per year for males
male_avg <- male_table %>%
  group_by(Period) %>%
  summarise(AverageLifeExpectancy = mean(`Life Expectancy`, na.rm = TRUE)) 

# Calculate the average life expectancy per year for females
female_avg <- female_table %>%
  group_by(Period) %>%
  summarise(AverageLifeExpectancy = mean(`Life Expectancy`, na.rm = TRUE))

#Combine the two tables into one
combined_avg <- bind_rows(male_avg %>% mutate(Gender = "Male"), 
                          female_avg %>% mutate(Gender = "Female"))

# Plot the combined data
ggplot(combined_avg, aes(x = Period, y = AverageLifeExpectancy, color = Gender, group = Gender)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Life Expectancy Over Years by Gender",
    x = "Period",
    y = "Life Expectancy",
    color = "Gender"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

## Basic Data Summary

The table below shows the basic summary of the mean, median, max, standard deviation, variance and sample size of life expectancy. We could tell that the average of the life expectancy from the 6 years is 45.9, with a large standard deviation of 26.9. The max of the life expectancy is 87.4, among all 6624 rows of data. The standard deviation and variance are extremely high because of the range of data is large, in other words, because the mean and median are 45.9 and 37.7, compared to the max 87.4, there is likely some outliers in the data creating such a high standard deviation and variance.

```{r}
#| label: fig-summary
#| fig-cap: "Summary statistics of the number of life expectancy over countries and years. "
#| echo: false
#| eval: true
#| warning: false
#| message: false

# Calculate summary statistics
life_expectancy_stats <- lelecleaned_data %>%
  summarise(
    Mean = round(mean(`Life Expectancy`, na.rm = TRUE),1),
    Median = median(`Life Expectancy`, na.rm = TRUE),
    Max = max(`Life Expectancy`, na.rm = TRUE),
    SD = round(sd(`Life Expectancy`, na.rm = TRUE),1),
    Variance = round(var(`Life Expectancy`, na.rm = TRUE),1),
    N = sum(!is.na(`Life Expectancy`)) # Count of non-missing values
  )

# Create and format the table
life_expectancy_stats %>%
  kbl(
    caption = "Summary Statistics of Life Expectancy",
    col.names = c("Mean", "Median","Max", "Standard Deviation", "Variance", "N"),
    align = "c"
  ) %>%
  kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed"))

```

# Model

## Model set-up {#sec-modset}

The goal of the Bayesian model is to incorporate prior knowledge, such as insights from previous studies or analyses, into the selection of the model. To predict the outcome of the life expectancy of people from different regions, in this paper, we developed a linear regression models using R [@citeR]. The outcome variable, **`Life Expectancy`**, is a continuous and represents the average number of years a person is expected to live, assuming all related resources remain constant throughout their lifetime. The model aim to estimate and predict the life expectancy of people under different gender, region and income group. The normal Gaussian distribution is effective when used for modeling scenarios where the residuals of the data aare assumed to be independent nd normally distributed around the regression line. The GAM allows for capturing potential non-linear relationships between the predictors and the outcome.

The model is specified as follows:

\begin{align} 
y_i|\mu_i, \sigma &\sim \mbox{Normal}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_i + \gamma_i\\
\alpha &\sim \mbox{Normal}(0, 2.5) \\
\beta &\sim \mbox{Normal}(0, 2.5) \\
\gamma &\sim \mbox{Normal}(0, 2.5) \\
\sigma &\sim \mbox{Exponential}(1)
\end{align}

Where:

-   $yi$ is the outcome variable (Life Expectancy)for the i-th country.

-   $_i$ represents the expected value of $yi$, modeled as a linear combination of the predictors: Gender, Region, and Income Group.

-   $Gender$ is the gender of the individual. 

-   $Income Group$ is the income group of the country.

-   $\epsilon_i$ is the error term, assumed to be normally distributed with a mean of 0 and constant variance $ϵ_i​∼N(0,\sigma^2)$




This GAM model allows for smooth, non-linear effects of continuous predictors (**`age`** and **`races_count`**) while keeping the categorical predictors (**`Income_Group`** and **`iaaf_category`**) in a linear framework.


[Appendix -@sec-model-details].

We run the model in R [@citeR] using the `rstanarm` package of @rstanarm. We use the default priors from `rstanarm`.

### Model justification

We expect a positive relationship between the size of the wings and time spent aloft. In particular...

We can use maths by including latex between dollar signs, for instance $\theta$.

#### Model Validation

RMSE 
 
Out-of- Sample testing


# Results

Our results are summarized in @tbl-modelresults.

1.  check different continent has its different life expectancy.
2.  compare the develop country with
3.  check the shcooling year of develop countries to developing country, showing a relationship between shcooling with the life expenctancy.
4.  

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

library(rstanarm)

model_developed <-
  readRDS(file = here::here("models/lm_model_developed.rds"))
```

```{r}
#| echo: false
#| eval: true
#| label: tbl-modelresults
#| tbl-cap: "Explanatory models of flight time based on wing width and wing length"
#| warning: false

#modelsummary::modelsummary(
  #list(
    #"developed model" = #model_developed
  #),
  #statistic = "mad",
  #fmt = 2
#)
```

# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this.

## Second discussion point

Please don't use these as sub-heading labels - change them to be what your point actually is.

## Life Expectancy at 60

The life expectancy at 60 means that how long is a person expected to live at 60 instead of at birth.

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {#sec-appendix}

## Data Cleaning Notes

We began by importing the raw dataset using the read_csv function from the tidyverse package. To focus our analysis on more relevant variables, we selected specific columns, such as percentage of expenditure of the country, total health expenditure by government .etc., omitting any unnecessary columns.

We filter out the rows containing NA values in any of the selected columns for reducing the noise and simpler further analysis..

We then renaming columns for clarity. For example, we changed ‘Income.composition.of.resources’ into ‘IncomeComposition’ , making it easier for anyone working with the data to read and understand what each variable represents.

Each column is rounded using the round function, specifying the desired number of decimal places for each. Columns not mentioned in mutate remain unchanged. This ensures a flexible and precise cleaning process tailored to further compairation and graphing.

We also modified the country name of ‘Republic of Korea’ under Country variable to ‘South Korea’ to avoid misunderstanding of North Korea.

We also created a new variable called Continent, which indicates which continent does the country comes from in order to provide a geographical context to the analysis. Life expectancy may be higher in developed regions like Europe or North America compared to regions like Sub-Saharan Africa due to differences in healthcare, living standards, and economic development.

We also wrapped the cleaning process in a tryCatch block in order to mitigate any errors that arose throughout the cleaning process.

After completing the cleaning, we saved the final dataset in both Parquet and CSV formats for later analysis.

## Data Cleaning Table

### Idealized Survey

**Survey: Understanding Life Expectancy and Influencing Factor**

Thank you for participating in this survey. This survey aims to gather insights into the factors influencing life expectancy, including health expenditure, education, ethnicity, government spending on healthcare, and income levels. Your responses will help us understand individual perspectives and experiences towards national policy. Participation is voluntary, and your answers will remain anonymous.

**Contact Information:** If you have any questions about the survey or the data collection process, please contact

**Survey Coordinator**: Yanfei Huang\
**Email**: yanfei.huang\@mail.utoronto.ca

**Section 1: Personal Health Expenditure**

**1.What percentage of your monthly income do you spend on healthcare (e.g., insurance, medications, doctor visits)?**

-   Less than 5%
-   5%–10%
-   10%–20%
-   More than 20%

**2.Do you or your household have health insurance coverage?**

-   Yes
-   No

**3. How frequently do you visit a healthcare professional(eg.doctors, nurse) in a year?**

-   0-1 times
-   2-5 times
-   6-10 times
-   More than 10 times

**Section 2: Education Background**

**4.What is the highest level of education you have completed?**

-   No formal education
-   Primary school
-   Secondary school
-   College or university degree
-   Postgraduate degree

**5.How many years of formal schooling have you completed?**

Please write the number: \_\_\_\_\_\_\_

**Section 3: Ethnicity and Geographic Factors**

**6.Which of the following best describes your ethnicity?**

-   African
-   Asian
-   European
-   Hispanic or Latino
-   Middle Eastern
-   Indigenous
-   Other (please specify): \_\_\_\_\_\_\_

**7.What's the distance to the nearest healthcare facility from your residence?**

-   Less than 1 km
-   1-5 km
-   More than 5 km

**Section 4: Government Expenditure on Healthcare**

**8.Are health services in your country subsidized by the govenment?**

-   Yes, fully subsidized
-   Yes, partially subsidized
-   No

**9. What is the approximate cost of your most recent healthcare visit (in local currency)?**

Please write the amount \_\_\_\_\_\_\_

**10.Do public healthcare facilities in your area provide all the services you need?**

-   Yes
-   No
-   Not applicable

**Section 5: Income and Development Factor**

**11.What is your approximate monthly household income after taxes?(in local currency)**

-   Less than 1,000
-   1,000 - 2,999
-   3,000 - 4,999
-   5,000 - 7,999
-   8,000 - 10,999
-   More than 11,000
-   Prefer not to say

**12.How would you describe your current financial situation?**

-   Struggling to make ends meet
-   Just getting by
-   Comfortable, but not wealthy
-   Financially secure
-   Wealthy
-   Prefer not to say

**13.How often do you have difficulty affording basic healthcare (medical visits, medications, etc.)?**

-   Never
-   Rarely
-   Sometimes
-   Often
-   Always
-   Prefer not to say

**Final Section**

Thank you for completing this survey! Your responses will help capture information about economic conditions, access to healthcare and education, and basic living standards, which are critical for understanding life expectancy predictors and the impact of socioeconomic factors on health outcomes.

# Additional data details

# Model details {#sec-model-details}

## Additional graph for analysis

```{r}
#| label: fig-continent
#| fig-cap: "Distribution of contient. Africa has the highest number of countries represented, followed by Asia among all 5 continents. The distribution of count of data aslo shows that a significant portion of the data is focused on African and Asian nations.  "
#| echo: false
#| eval: true
#| warning: false
#| message: false

#Calculate the number of unique countries per continent
continent_count <- cleaned_expectancy %>%
  group_by(Continent) %>%
  summarise(num_countries = n_distinct(Country))

#Plot1: Distribution of number of data per continent
#Create the bar plot showing the number of data per continent
continentrow <- ggplot(cleaned_expectancy, aes(x = Continent)) +
  geom_bar(fill = "orange", color = "white") +
  labs(
    title = "Distribution of Count by Continent",
    x = "Continent",
    y = "Count"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(size = 10, face = "bold"),
    axis.title = element_text(size = 10)
  ) +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5, size = 2.5)

# Plot2: The distribution of number of countries each continent
#Create the bar plot showing the number of unique countries per continent
continentnumber <-ggplot(continent_count, aes(x = Continent, y = num_countries)) +
  geom_bar(stat = "identity", fill = "#FFA07A", color = "white") +
  labs(
    title = "Distribution of Country by Continent",
    x = "Continent",
    y = "Number of Country"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(size = 10, face = "bold"),
    axis.title = element_text(size = 10)
  ) +
  geom_text(aes(label = num_countries), vjust = -0.5, size = 2.5)

# Arrange the plots side by side
grid.arrange(continentnumber, continentrow, ncol = 2)
```

## Posterior predictive check

In @fig-ppcheckandposteriorvsprior-1 we implement a posterior predictive check. This shows...

In @fig-ppcheckandposteriorvsprior-2 we compare the posterior with the prior. This shows...

```{r}
#| eval: true
#| echo: false
#| message: false
#| warning: false
#| label: fig-ppcheckandposteriorvsprior
#| layout-ncol: 2
#| fig-cap: "Examining how the model fits, and is affected by, the data"
#| fig-subcap: ["Posterior prediction check", "Comparing the posterior with the prior"]

#pp_check(model_developed) +
  #theme_classic() +
  #theme(legend.position = "bottom")

#posterior_vs_prior(model_developed) +
  #theme_minimal() +
  #scale_color_brewer(palette = "Set1") +
  #theme(legend.position = "bottom") +
  #coord_flip()
```

## Diagnostics

@fig-stanareyouokay-1 is a trace plot. It shows... This suggests...

@fig-stanareyouokay-2 is a Rhat plot. It shows... This suggests...

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-stanareyouokay
#| fig-cap: "Checking the convergence of the MCMC algorithm"
#| fig-subcap: ["Trace plot", "Rhat plot"]
#| layout-ncol: 2

#plot(model_developed, "trace")

#plot(model_developed, "rhat")
```

\newpage

# References
